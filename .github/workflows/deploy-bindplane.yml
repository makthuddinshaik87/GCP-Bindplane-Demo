name: BindPlane GCP Demo Deployment

on:
  workflow_dispatch:

env:
  TF_VERSION: 1.6.6
  TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
  TF_VAR_region: ${{ secrets.GCP_REGION }}
  TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
  TF_VAR_admin_password: ${{ secrets.BINDPLANE_ADMIN_PASSWORD }}

# =========================================================
#  CLOUD SQL POSTGRESQL (IDEMPOTENT)
# =========================================================
jobs:
  part1-db:
    name: Cloud SQL PostgreSQL (Import if Exists)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init – Cloud SQL
        working-directory: terraform/part1-db
        run: terraform init

      - name: Terraform Apply – Cloud SQL (Import if exists)
        working-directory: terraform/part1-db
        run: |
          set -e

          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          INSTANCE="bp-postgres"
          DB="bindplane"
          USER="bindplane"

          echo "Checking Cloud SQL instance..."
          if gcloud sql instances describe "$INSTANCE" \
            --project "$PROJECT_ID" >/dev/null 2>&1; then
            terraform import google_sql_database_instance.postgres "$INSTANCE" || true
          fi

          echo "Checking Cloud SQL database..."
          if gcloud sql databases describe "$DB" \
            --instance "$INSTANCE" \
            --project "$PROJECT_ID" >/dev/null 2>&1; then
            terraform import google_sql_database.bindplane "$INSTANCE/$DB" || true
          fi

          echo "Checking Cloud SQL user..."
          if gcloud sql users list \
            --instance "$INSTANCE" \
            --project "$PROJECT_ID" \
            --format="value(name)" | grep -q "^$USER$"; then
            terraform import google_sql_user.bindplane "$INSTANCE/$USER" || true
          fi

          terraform apply -auto-approve

      - name: Wait until Cloud SQL PostgreSQL is ACTIVE
        run: |
          echo "Waiting for Cloud SQL instance to be RUNNABLE..."
          for i in {1..30}; do
            STATE=$(gcloud sql instances describe bp-postgres \
              --project "${{ secrets.GCP_PROJECT_ID }}" \
              --format="value(state)") || STATE="UNKNOWN"
            echo "Current state: $STATE"
            if [ "$STATE" = "RUNNABLE" ]; then
              echo "Cloud SQL PostgreSQL is ACTIVE"
              exit 0
            fi
            sleep 15
          done
          echo "Cloud SQL did not become ACTIVE"
          exit 1

# =========================================================
#  BINDPLANE CONTROL PLANE
# =========================================================
  part2-control-plane:
    name: BindPlane Control Plane (Wait Until ACTIVE)
    runs-on: ubuntu-latest
    needs: part1-db

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init – Control Plane
        working-directory: terraform/part2-control-plane
        run: terraform init

      - name: Terraform Apply – Control Plane
        working-directory: terraform/part2-control-plane
        run: terraform apply -auto-approve

      # - name: Wait until BindPlane Control Plane is ACTIVE
      #   working-directory: terraform/part2-control-plane
      #   run: |
      #     CP_IP=$(terraform output -raw control_plane_ip)
      #     echo "Waiting for BindPlane UI on http://$CP_IP:3001"

      - name: Wait until BindPlane Control Plane is ACTIVE
        working-directory: terraform/part2-control-plane
        env:
          MAX_TRIES: "30"       # ~7.5 minutes at 15s interval
          SLEEP_SEC: "15"
        run: |
          set -euo pipefail

          CP_IP="$(terraform output -raw control_plane_ip)"
          if [[ -z "${CP_IP}" ]]; then
            echo "ERROR: terraform output control_plane_ip is empty"
            exit 1
          fi

          echo "Waiting for BindPlane UI on http://${CP_IP}:3001"
          for ((i=1; i<=MAX_TRIES; i++)); do
            # Try to fetch just the headers quickly; follow redirects; fail on non-2xx/3xx
            if curl -sS -f -L -o /dev/null \
                 --max-time 5 \
                 --connect-timeout 3 \
                 "http://${CP_IP}:3001"; then
              echo "BindPlane Control Plane is ACTIVE (try ${i}/${MAX_TRIES})"
              exit 0
            else
              # For diagnosis, capture status code if reachable
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                         --max-time 5 --connect-timeout 3 \
                         "http://${CP_IP}:3001" || true)
              echo "Not ready yet (try ${i}/${MAX_TRIES}). HTTP ${STATUS:-N/A}. Retrying in ${SLEEP_SEC}s…"
            fi
            sleep "${SLEEP_SEC}"
          done

          echo "Control Plane did not become ACTIVE after $((MAX_TRIES*SLEEP_SEC)) seconds."
          exit 1

# =========================================================
#  BINDPLANE AGENT
# =========================================================
  part3-agents:
    name: BindPlane Agent (Wait Until ACTIVE)
    runs-on: ubuntu-latest
    needs: part2-control-plane

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init – Agent
        working-directory: terraform/part3-agents
        run: terraform init

      - name: Terraform Apply – Agent
        working-directory: terraform/part3-agents
        run: terraform apply -auto-approve

      - name: Wait until Agent is ACTIVE (Registered)
        working-directory: terraform/part2-control-plane
        run: |
          CP_IP=$(terraform output -raw control_plane_ip)
          echo "Checking agent registration via BindPlane API"
          for i in {1..30}; do
            COUNT=$(curl -sf http://$CP_IP:3001/api/v1/agents | jq '.agents | length')
            if [ "$COUNT" -ge 1 ]; then
              echo "BindPlane Agent is ACTIVE and registered"
              exit 0
            fi
            sleep 15
          done
          echo "Agent did not become ACTIVE"
          exit 1
